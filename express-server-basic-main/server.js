import express from 'express';
import multer from 'multer';
import fs from 'fs';
import path from 'path';

const app = express();
app.use(express.json());

// SET STORAGE
var storage = multer.diskStorage({
    destination: function (req, file, cb) {
        cb(null, 'uploads')
    },
    filename: function (req, file, cb) {
        cb(null, file.fieldname + '-' + Date.now())
    }
})

var upload = multer({ storage: storage })

let i = 1;
app.post('/uploadphoto', upload.single('image'), (req, res) => {
    var img = fs.readFileSync(req.file.path);
    var encode_image = img.toString('base64');

    var finalImg = {
        contentType: req.file.mimetype,
        image: Buffer.from(encode_image, 'base64')
    };
    const folderWay = path.resolve() + "\\" + `uploads\\image${i}.png`;
    
    fs.writeFileSync(folderWay, finalImg.image, {encoding: 'base64'}, function(err) {
        console.log('File created');
    });
    const folderPath = path.resolve() + "\\" + "uploads\\";
    const files = fs.readdirSync(folderPath);
    for(let i = 0; i< files.length; i++){
        if(files[i].toString().includes('image-')){
            fs.unlink(folderPath + files[i].toString(), (err) => {
                if(err) console.log(`${err}`)
                console.log("Ok");
            })
        }
    }
    i++;
    res.send({ok:'OK'});
})


app.listen(8080, () => {
    console.log(`Server is Listening ${8080}`);
});